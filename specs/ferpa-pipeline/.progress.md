# Spec Progress: ferpa-pipeline

## Goal
Improve pipeline

## Phase History
- [research] Started: 2026-01-15
- [research] Completed: 2026-01-15 - Awaiting approval
- [requirements] Started: 2026-01-15
- [requirements] Completed: 2026-01-15 - Awaiting approval
- [design] Started: 2026-01-15
- [design] Completed: 2026-01-15 - Awaiting approval
- [tasks] Started: 2026-01-15
- [tasks] Completed: 2026-01-15 - 42 tasks created, awaiting approval

## Completed Tasks
- [x] 1.1.1 Create src/ferpa_feedback directory structure - e92fd6c
- [x] 1.1.2 Create __init__.py files for package - f2e40bb
- [x] 1.2.1 Move models.py to src/ferpa_feedback/ - cb0ed83
- [x] 1.2.2 Create unified stage_0_ingestion.py using models.py StudentComment - 13d5e38
- [x] 1.2.3 Move stage_1_grammar.py to src/ferpa_feedback/ - b9502b2
- [x] 1.2.4 Move stage_3_anonymize.py to src/ferpa_feedback/ - e61b154

## Current Task
Awaiting next task

## Next
Task 1.2.5: Quality Checkpoint

## Learnings
- Project structure mismatch: pyproject.toml expects src/ferpa_feedback/ but files are at root level
- Stage 2 (name verification) is imported in pipeline.py but does not exist - will cause runtime crash
- Stage 4 (semantic analysis) and Stage 5 (human review) are designed in README/models but not implemented
- Two incompatible StudentComment definitions: dataclass in stage_0_ingestion_improved.py vs Pydantic in models.py
- Dependencies GLiNER and rapidfuzz are listed but not actually used - intended for Stage 2
- Presidio can boost F-score ~30% with proper configuration - current setup uses defaults
- LanguageTool cold start takes 10-30 seconds - lazy loading pattern already partially implemented
- FERPA Gate pattern (detect -> anonymize -> re-detect) is well-designed for compliance
- Educational PII detection benefits from context-aware approaches vs generic NER (PIIvot research)
- Recall is more important than precision for PII detection - prefer catching false positives
- P0 priority items: project structure fix, Stage 2 implementation, model unification - all block pipeline from running
- User story approach: 8 stories covering structural fixes, missing features, and optimizations
- FERPA Gate enforcement is critical for Stage 4 - must verify no PII reaches external API
- Stage 5 review UI depends on FastAPI optional dependency - consider mandatory if required
- Name edge cases (O'Brien, McDonald, hyphenated) need explicit test coverage
- 95% PII recall target aligns with regulatory best practices for educational data
- Architecture decision: GLiNER primary + spaCy fallback for Stage 2 NER - both already in deps
- FERPAEnforcedClient wrapper pattern ensures single enforcement point for API calls
- Custom Presidio recognizers needed for StudentID, GradeLevel, SchoolName patterns
- token_sort_ratio algorithm best for name matching with order variations (John Smith vs Smith, John)
- Factory function pattern (create_*) must be preserved for consistency with existing stages
- Frozen Pydantic models require returning new instances from all processors
- Migration path: 6 phases from structure fix through CLI polish
- Task planning: 42 total tasks across 4 phases (POC, Refactoring, Testing, Quality Gates)
- Quality checkpoints inserted every 2-3 tasks to catch issues early
- POC phase focuses on making pipeline runnable with stubs before full implementation
- Stage 0 requires adapter work: dataclass StudentComment must be replaced with Pydantic version
- Stage 2 stub allows pipeline to run while full GLiNER/rapidfuzz implementation follows
- Critical dependency: Stage 4 MUST receive FERPA gate to prevent PII leakage
- Test coverage target: 80% for critical stages (2, 3, 4)
- Integration test must verify "no PII reaches API" as compliance requirement
- Python 3.9 compatibility: Use Optional[X] and Union[X, Y] instead of X | Y syntax (requires Python 3.10+)
